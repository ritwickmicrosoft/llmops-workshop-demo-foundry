# =============================================================================
# CD Pipeline - Deploy to Azure
# =============================================================================
# Deploys infrastructure and application to Azure App Service
# Uses Managed Identity for RBAC authentication
# =============================================================================

name: CD - Deploy to Azure

on:
  push:
    branches: [main]
    paths:
      - '04-frontend/**'
      - 'infra/**'
      - '.github/workflows/cd-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_infra:
        description: 'Deploy infrastructure changes'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  AZURE_WEBAPP_NAME: 'walle-chatbot'
  
# Prevent concurrent deployments to same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Set Environment Variables
  # ===========================================================================
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      resource_group: ${{ steps.env.outputs.resource_group }}
      webapp_name: ${{ steps.env.outputs.webapp_name }}
    steps:
      - name: Determine environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "resource_group=rg-llmops-$ENV" >> $GITHUB_OUTPUT
          echo "webapp_name=walle-chatbot-$ENV" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Deploy Infrastructure (Bicep)
  # ===========================================================================
  deploy-infra:
    name: ðŸ—ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.deploy_infra == 'true' || github.event_name == 'push'
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      openai_endpoint: ${{ steps.deploy.outputs.openaiEndpoint }}
      search_endpoint: ${{ steps.deploy.outputs.searchEndpoint }}
      foundry_endpoint: ${{ steps.deploy.outputs.foundryEndpoint }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          region: eastus
          template: infra/main.bicep
          parameters: >
            resourceGroupName=${{ needs.setup.outputs.resource_group }}
            environment=${{ needs.setup.outputs.environment }}
            principalId=${{ secrets.AZURE_PRINCIPAL_ID }}
            principalType=ServicePrincipal
          deploymentName: llmops-${{ github.run_number }}

      - name: Output deployment info
        run: |
          echo "### ðŸ—ï¸ Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ needs.setup.outputs.resource_group }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAI Endpoint | ${{ steps.deploy.outputs.openAIEndpoint }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Deploy Application
  # ===========================================================================
  deploy-app:
    name: ðŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: [setup, deploy-infra]
    if: always() && needs.setup.result == 'success'
    environment: 
      name: ${{ needs.setup.outputs.environment }}
      url: https://${{ needs.setup.outputs.webapp_name }}.azurewebsites.net
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp 04-frontend/app.py deploy/
          cp 04-frontend/index.html deploy/
          cp requirements.txt deploy/
          
          # Create startup script
          echo "gunicorn --bind=0.0.0.0:8000 --workers=2 app:app" > deploy/startup.sh
          
          # Create requirements for webapp
          cat > deploy/requirements.txt << 'EOF'
          flask>=2.0.0
          flask-cors>=4.0.0
          gunicorn>=21.0.0
          openai>=1.0.0
          azure-identity>=1.15.0
          azure-search-documents>=11.4.0
          EOF

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create App Service (if not exists)
        run: |
          WEBAPP="${{ needs.setup.outputs.webapp_name }}"
          RG="${{ needs.setup.outputs.resource_group }}"
          
          # Check if webapp exists
          if ! az webapp show --name $WEBAPP --resource-group $RG &>/dev/null; then
            echo "Creating App Service Plan and Web App..."
            
            az appservice plan create \
              --name "${WEBAPP}-plan" \
              --resource-group $RG \
              --location eastus \
              --sku B1 \
              --is-linux
            
            az webapp create \
              --name $WEBAPP \
              --resource-group $RG \
              --plan "${WEBAPP}-plan" \
              --runtime "PYTHON:3.11"
            
            # Enable Managed Identity
            az webapp identity assign \
              --name $WEBAPP \
              --resource-group $RG
          fi

      - name: Configure App Settings
        run: |
          WEBAPP="${{ needs.setup.outputs.webapp_name }}"
          RG="${{ needs.setup.outputs.resource_group }}"
          
          az webapp config appsettings set \
            --name $WEBAPP \
            --resource-group $RG \
            --settings \
              AZURE_OPENAI_ENDPOINT="${{ needs.deploy-infra.outputs.openai_endpoint || secrets.AZURE_OPENAI_ENDPOINT }}" \
              AZURE_SEARCH_ENDPOINT="${{ needs.deploy-infra.outputs.search_endpoint || secrets.AZURE_SEARCH_ENDPOINT }}" \
              AZURE_OPENAI_CHAT_DEPLOYMENT="gpt-4o" \
              AZURE_OPENAI_EMBEDDING_DEPLOYMENT="text-embedding-3-large" \
              AZURE_SEARCH_INDEX_NAME="walle-products" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ needs.setup.outputs.webapp_name }}
          package: deploy/

      - name: Health Check
        run: |
          WEBAPP="${{ needs.setup.outputs.webapp_name }}"
          URL="https://${WEBAPP}.azurewebsites.net/api/health"
          
          echo "Waiting for deployment to stabilize..."
          sleep 30
          
          echo "Checking health endpoint: $URL"
          for i in {1..5}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Attempt $i: HTTP $RESPONSE - retrying..."
            sleep 10
          done
          
          echo "âš ï¸ Health check did not pass, but deployment completed"
          exit 0

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ needs.setup.outputs.webapp_name }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Test the deployment:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl https://${{ needs.setup.outputs.webapp_name }}.azurewebsites.net/api/health" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Grant RBAC Permissions
  # ===========================================================================
  configure-rbac:
    name: ðŸ” Configure RBAC
    runs-on: ubuntu-latest
    needs: [setup, deploy-app]
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Managed Identity
        id: identity
        run: |
          WEBAPP="${{ needs.setup.outputs.webapp_name }}"
          RG="${{ needs.setup.outputs.resource_group }}"
          
          PRINCIPAL_ID=$(az webapp identity show \
            --name $WEBAPP \
            --resource-group $RG \
            --query principalId -o tsv)
          
          echo "principal_id=$PRINCIPAL_ID" >> $GITHUB_OUTPUT

      - name: Grant Cognitive Services User role
        run: |
          # Grant access to Azure OpenAI
          az role assignment create \
            --role "Cognitive Services OpenAI User" \
            --assignee-object-id ${{ steps.identity.outputs.principal_id }} \
            --assignee-principal-type ServicePrincipal \
            --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ needs.setup.outputs.resource_group }}" \
            || echo "Role may already exist"

      - name: Grant Search Index Data Reader role
        run: |
          # Grant access to Azure AI Search
          az role assignment create \
            --role "Search Index Data Reader" \
            --assignee-object-id ${{ steps.identity.outputs.principal_id }} \
            --assignee-principal-type ServicePrincipal \
            --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ needs.setup.outputs.resource_group }}" \
            || echo "Role may already exist"
